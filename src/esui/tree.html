<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
	<!-- 建议 -->
	<!-- 对于页面、css资源、javascript资源， -->
	<!-- 请使用地球计算机都能识别的UTF-8编码。 -->
	
	<title>Sample</title>
	<style>
	.part { 
		margin-right:10px;
		width:400px;
		height:400px;
		overflow-x:hidden;
		overflow-y:auto;
		border:2px solid #888;
		float:left;
	}

	.tree-node {
		cursor:pointer;
		border-bottom:1px solid #888;
		height:20px;
		line-height:20px;
		padding:2px 5px;
		background:url(../../demo/css/img/esui.png);
	}

	.tree-node-expanded {
		background:#f5f5f5;
	}

	.tree-node:hover {
		background:#ececec;
	}

	.tree-subwrap {
		padding-left:30px;
		border-bottom:1px solid #888;
		display:none;
	}

	.tree-subwrap-expanded {
		display:block;
	}
	</style>
</head>

<body>
	<div class="header">Sample</div>
	<div class="main" id="Main">
		<div id="Source" class="part"></div>
		<div id="Selected" class="part"></div>
	</div>
	<script>
	function TimeTracer() {
		this.now = new Date;
		this.records = [];
	}

	TimeTracer.prototype = {
		record: function ( msg ) {
			this.records.push( msg + ':' + (new Date() - this.now) + 'ms' );
			this.now = new Date;
		},

		alert: function () {
			alert( this.records.join( '\n' ) );
		}
	};
	var dataLoadTrace = new TimeTracer();
	</script>
	<script src="data.php" type="text/javascript"></script>
	<script>

	dataLoadTrace.record( 'load data' );
	dataLoadTrace.alert();

	function g( id ) {
		return document.getElementById( id );
	}
	
	var ieVer;
	if (/msie (\d+\.\d)/i.test(navigator.userAgent)) {
        ieVer = parseFloat(RegExp['\x241']);
    }
	/*
	 * 让IE6缓存背景图片
	 */
	if ( ieVer && ieVer < 7 ) {
		try {
			document.execCommand("BackgroundImageCache", false, true);
		} catch(e){}
	}

	/**
	 * 树控件类
	 *
	 * @class
	 * @param {Object} option 初始化参数
	 */
	function TreeView( option ) {
		this.id		= option.id;
		this.main	= option.main;
		this.data	= option.data;

		this._nodeClass			= 'tree-node';
		this._nodeExpandedClass = 'tree-node-expanded';
		this._swClass			= 'tree-subwrap';
		this._swExpandedClass	= 'tree-subwrap-expanded';

		this._nodeIdPrefix = 'TreeNode';
		this._subIdPrefix  = 'SubWrap';

		this._dataKV = {};
		this._canClear = [];

		this.MAX_RENDERED = 10;
	}

	TreeView.prototype = {
		/**
		 * 绘制控件
		 */
		render: function () {
			// 时间记录
			var tracer = new TimeTracer();

			this.main.innerHTML = this._getChildrenHtml( this.data.children );
			this.main.onclick = this._getMainClickHandler();

			tracer.record( 'render time' );
			tracer.alert();
		},

		/**
		 * 获取子节点的html片段
		 *
		 * @private
		 * @param {Array} children 子节点数组
		 * @return {string}
		 */
		_getChildrenHtml: function ( children ) {
			var i, len, id, item, itemChilds;
			var html	= [];
			var tpl		= this._nodeTpl;
			var nodeIdPrefix = this._nodeIdPrefix;
			var subIdPrefix  = this._subIdPrefix;
			var args;

			for ( i = 0, len = children.length; i < len; i++ ) {
				item		= children[ i ];
				id			= item.id;
				itemChilds	= item.children;

				this._dataKV[ id ] = item;
				args = [
					id,
					this._getId( nodeIdPrefix + id ),
					this._nodeClass,
					(itemChilds instanceof Array && itemChilds.length > 0 ? '1' : ''),
					item.text,
					this._getId( subIdPrefix + id ),
					this._swClass
				];

				html.push(
					tpl.replace( /\{(\d+)\}/g, function ( $0, $1 ) {
						return args[ parseInt( $1, 10 ) ];
					})
				);
			}

			return html.join( '' );
		},

		_nodeTpl: '<div id="{1}" class="{2}" data-id="{0}" data-haschild="{3}">{4}</div>'
					+ '<div id="{5}" class="{6}"></div>',

		/**
		 * 获取控件点击行为的处理函数
		 *
		 * @private
		 */
		_getMainClickHandler: function () {
			var me = this;

			return function ( e ) {
				e = e || window.event;

				var id;
				var target			= e.srcElement || e.target;
				var nodeClass		= me._nodeClass;
				var sRenderedAttr	= 'data-subrendered';
				var subIdPrefix		= me._subIdPrefix;
				var children;
		
				// 时间记录
				var tracer = new TimeTracer();

				if ( 
					target.className.indexOf( nodeClass ) == 0 
					&& target.getAttribute( 'data-haschild' ) 
				) {
					id = target.getAttribute( 'data-id' );

					if ( !target.getAttribute( sRenderedAttr ) ) {
						children = me._dataKV[ id ].children;

						me._reduceDom();
						g( me._getId( subIdPrefix + id ) ).innerHTML = me._getChildrenHtml( children );
						me._canClear.push( id );
						target.setAttribute( sRenderedAttr, '1' );

						tracer.record( 'render time' );
					}

					me.toggleNode( id );

					tracer.record( 'toggle time' );
					tracer.alert();
				}
			}
		},
		
		/**
		 * 为dom减负，清空关闭的子节点
		 *
		 * @private
		 */
		_reduceDom: function () {
			var canClear = this._canClear;
			var len = canClear.length;
			var i;
			var id;
			var node;
			var maxRendered = this.MAX_RENDERED;
			

			for ( i = 0; len > maxRendered && i < len; ) {
				id = canClear[ i ];
				node = g( this._getId( this._nodeIdPrefix + id ) );
				
				if ( !node ) {
					canClear.splice( i, 1 );
					len--;
					continue;
				}

				if ( !node.getAttribute( 'data-isexpanded' ) ) {
					node.setAttribute( 'data-subrendered', '' );
					g( this._getId( this._subIdPrefix + id ) ).innerHTML = '';
					canClear.splice( i, 1 );
					len--;
					continue;
				}

				i++;
			}
		},

		/**
		 * 展开/收起 节点
		 *
		 * @param {string} id 节点id
		 */
		toggleNode: function ( id ) {
			var nClass	 = this._nodeClass;
			var neClass  = this._nodeExpandedClass;
			var swClass  = this._swClass;
			var sweClass = this._swExpandedClass;
			var nodeIdPrefix = this._nodeIdPrefix;
			var subIdPrefix  = this._subIdPrefix;

			var node = g( this._getId( nodeIdPrefix + id ) );
			var subwrap = g( this._getId( subIdPrefix + id ) );

			var isExpAttr = 'data-isexpanded';
			var isExpanded = node.getAttribute( isExpAttr );

			if ( !isExpanded ) {
				nClass += ' ' + neClass;
				swClass += ' ' + sweClass;
				node.setAttribute( isExpAttr, 1 );
			} else {
				node.setAttribute( isExpAttr, '' );
			}

			node.className = nClass;
			subwrap.className = swClass;
		},
		
		/**
		 * 获取控件的子部件id
		 *
		 * @private
		 * @param {string} part 子部件名
		 */
		_getId: function ( part ) {
			return this.id + part;
		}
	};

	

	window.onload = function () {
		var myTree = new TreeView( {
			id		: 'myTree',
			main	: document.getElementById( 'Source' ),
			data	: data
		} );

		myTree.render();
	};
	</script>
</body>
</html>
